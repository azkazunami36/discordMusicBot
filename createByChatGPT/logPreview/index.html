<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>sumlogJSON.jsonl viewer (server-side search & newest-first paging)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
    header { position: sticky; top: 0; background: #f6f7f9; border-bottom: 1px solid #ccc; padding: 8px 12px; display:flex; gap:8px; align-items:center; z-index: 5; }
    header .spacer { flex: 1; }
    .btn { padding: 6px 10px; border: 1px solid #aaa; background: #fff; cursor: pointer; }
    .btn:disabled { opacity: .5; cursor: default; }
    .stat { color:#555; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border: 1px solid #aaa; padding: 4px; vertical-align: top; word-break: break-word; white-space: normal; overflow-wrap: anywhere; }
    th { background: #eee; position: sticky; top: 46px; z-index: 4; }
    /* 固定幅列 */
    col.col-idx { width: 60px; }       /* # は固定60px */
    col.col-date { width: 180px; }     /* dateは固定180px */
    col.col-type { width: 55px; }      /* typeは固定55px */
    col.col-func { width: 220px; }     /* functionNameは固定220px（+20px） */
    col.col-message { width: 50%; }    /* messageは全体の50% */
    /* センタリング */
    th.center, td.center { text-align: center; }
    /* 可変列の最小幅（functionName以降）*/
    th:nth-child(n+4), td:nth-child(n+4) { min-width: 120px; }
    /* message列の最小幅（5列目）*/
    th:nth-child(5), td:nth-child(5) { min-width: 250px; }
    /* type の強調 */
    td.type-warn { background: #f39c12; color: #fff; font-weight: 900; }
    td.type-error { background: #e74c3c; color: #fff; font-weight: 900; }
  </style>
</head>
<body>
  <header>
    <button id="prev" class="btn">← 前へ</button>
    <button id="next" class="btn">次へ →</button>
    <div id="pageInfo">Page 1 / 1</div>

    <div style="display:flex; gap:6px; align-items:center;">
      <input id="searchBox" type="text" placeholder="Search (全体検索)" style="padding:4px 6px; width: 320px;" />
      <select id="searchField" style="padding:4px 6px;">
        <option value="type">type</option>
        <option value="functionName">functionName</option>
        <option value="message" selected>message</option>
        <option value="user">user</option>
        <option value="guild">guild</option>
        <option value="textChannel">textChannel</option>
        <option value="voiceChannel">voiceChannel</option>
      </select>
      <label style="display:flex; gap:4px; align-items:center;"><input id="excludeToggle" type="checkbox" /> 除外</label>
    </div>

    <!-- 検索中のみ表示する範囲UI -->
    <div id="rangeUI" style="display:none; gap:6px; align-items:center;">
      <button id="wprev" class="btn">範囲 ←</button>
      <div id="winfo">Window 1 / 1</div>
      <button id="wnext" class="btn">→ 範囲</button>
    </div>

    <div class="spacer"></div>
    <div class="stat">
      <span id="rowsStat">rows: 0</span> /
      <span id="bytesStat">size: 0B</span>
    </div>
  </header>

  <table id="table">
    <colgroup>
      <col class="col-idx">
      <col class="col-date">
      <col class="col-type">
      <col class="col-func">
      <col class="col-message">
      <col>
      <col>
      <col>
      <col>
    </colgroup>
    <thead>
      <tr>
        <th class="center">#</th>
        <th class="center">date</th>
        <th class="center">type</th>
        <th>functionName</th>
        <th>message</th>
        <th>user</th>
        <th>guild</th>
        <th>textChannel</th>
        <th>voiceChannel</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    (async function boot(){
      const cfg = await fetch('/config', {cache:'no-store'}).then(r=>r.json());
      const PAGE_SIZE = Number(cfg.pageSize || 2500);
      const POLL_MS = Number(cfg.pollMs || 1000);
      const SEARCH_WINDOW_SIZE = Number(cfg.searchWindowSize || 50000);

      let mode = 'normal'; // 'normal' | 'search'
      let searchParams = {
        field: 'message', q: '', exclude: false,
        page: 1, totalPages: 1, total: 0,
        // 追加：範囲ウィンドウ情報
        windowIndex: 0, windowCount: 1, windowStartLine: 0, windowEndLine: 0
      };

      let lastPos=0,pending="",currentPage=1,totalPages=1,totalLines=0,fileSize=0,onLatestPage=true;
      const tbody=document.querySelector("#table tbody"),
            pageInfo=document.getElementById("pageInfo"),
            rowsStat=document.getElementById("rowsStat"),
            bytesStat=document.getElementById("bytesStat"),
            prevBtn=document.getElementById("prev"),
            nextBtn=document.getElementById("next"),
            searchBox=document.getElementById("searchBox"),
            searchFieldSel=document.getElementById("searchField"),
            excludeToggle=document.getElementById("excludeToggle"),
            rangeUI=document.getElementById("rangeUI"),
            wprevBtn=document.getElementById("wprev"),
            wnextBtn=document.getElementById("wnext"),
            winfo=document.getElementById("winfo");

      function setRangeUIVisible(v){
        rangeUI.style.display = v ? "flex" : "none";
      }
      function updateRangeUIState(){
        winfo.textContent = `Window ${searchParams.windowIndex+1} / ${searchParams.windowCount}`;
        wprevBtn.disabled = (searchParams.windowIndex<=0);
        wnextBtn.disabled = (searchParams.windowIndex>=(searchParams.windowCount-1));
      }

      function setPageInfo(){
        if(mode==='search'){
          pageInfo.textContent = `Page ${searchParams.page||1} / ${searchParams.totalPages||1} (search)`;
        }else{
          pageInfo.textContent = `Page ${currentPage||1} / ${totalPages||1}`;
        }
        prevBtn.disabled = (mode==='search' ? (searchParams.page<=1) : (currentPage<=1));
        nextBtn.disabled = (mode==='search' ? (searchParams.page>=searchParams.totalPages) : (currentPage>=totalPages));
      }
      function setRowsStatVal(){
        if(mode==='search'){
          rowsStat.textContent = "hits: " + (searchParams.total || 0);
        }else{
          rowsStat.textContent = "rows: " + (totalLines || 0);
        }
      }
      function humanBytes(n){
        if(n<1024) return n+"B";
        const u=["KB","MB","GB","TB"]; let i=-1,v=n;
        do{ v/=1024; i++; } while(v>=1024 && i<u.length-1);
        return v.toFixed(1)+u[i];
      }
      function splitLinesNoRegex(t){
        const o=[]; let s=0;
        for(let i=0;i<t.length;i++){
          const c=t.charCodeAt(i);
          if(c===10){ o.push(t.slice(s,i)); s=i+1; }
          else if(c===13){ o.push(t.slice(s,i)); if(i+1<t.length && t.charCodeAt(i+1)===10) i++; s=i+1; }
        }
        if(s<t.length) o.push(t.slice(s));
        return o;
      }
      function endsWithNewline(t){ if(!t) return false; const l=t.charCodeAt(t.length-1); return l===10||l===13; }
      function formatDate(ts){
        if(!ts) return "";
        const d=new Date(ts);
        const y=d.getFullYear(), m=d.getMonth()+1, da=d.getDate(), h=d.getHours(), mi=d.getMinutes(), s=d.getSeconds();
        const pad=n=>String(n).padStart(2,'0');
        return y+'/'+pad(m)+'/'+pad(da)+' '+pad(h)+':'+pad(mi)+':'+pad(s);
      }
      function normalize(v){ return (v==null?"":String(v)).toLowerCase(); }

      // ★ lines配列と、実JSONL開始行番号(offsetBase)またはnumbers配列から描画
      function appendRowsFromLines(lines, offsetBase, numbers){
        const f=document.createDocumentFragment();
        // when numbers is provided (search mode), use it directly; otherwise derive from offsetBase
        const useNumbers = Array.isArray(numbers) && numbers.length === lines.length;
        let base = (typeof offsetBase==='number' && offsetBase>=0) ? offsetBase : 0;

        for(let i=0;i<lines.length;i++){
          const line = lines[i];
          if(!line) continue;
          try{
            const d=JSON.parse(line), iinfo=d.info||{}, g=iinfo.guild||{}, tx=iinfo.textChannelId||{}, vx=iinfo.voiceChannelId||{}, u=iinfo.userId||{}, tr=document.createElement("tr");
            const userStr = u.globalName||u.displayName||u.username||"";
            const guildStr = g.name||g.id||"";
            const txStr = tx.name||tx.id||"";
            const vxStr = vx.name||vx.id||"";
            const fnStr = iinfo.functionName||"";
            const typeStr = (d.type||"").toString();

            // #（実際の JSONL 行番号）
            const displayNo = useNumbers ? Number(numbers[i])||0 : (base + i + 1);
            let td=document.createElement("td"); td.className="center"; td.textContent=String(displayNo); tr.appendChild(td);

            // date
            td=document.createElement("td"); td.className="center"; td.textContent=formatDate(d.date); tr.appendChild(td);
            // type（装飾）
            const t=typeStr.toLowerCase();
            td=document.createElement("td"); td.className="center";
            if(t.indexOf("error")!==-1) td.classList.add("type-error"); else if(t.indexOf("warn")!==-1) td.classList.add("type-warn");
            td.textContent=typeStr; tr.appendChild(td);
            // functionName
            td=document.createElement("td"); td.textContent=fnStr; tr.appendChild(td);
            // message
            td=document.createElement("td"); td.textContent=d.message||""; tr.appendChild(td);
            // user
            td=document.createElement("td"); td.textContent=userStr; tr.appendChild(td);
            // guild
            td=document.createElement("td"); td.textContent=guildStr; tr.appendChild(td);
            // textChannel
            td=document.createElement("td"); td.textContent=txStr; tr.appendChild(td);
            // voiceChannel
            td=document.createElement("td"); td.textContent=vxStr; tr.appendChild(td);

            // dataset（クリック検索用）
            tr.dataset.type = normalize(typeStr);
            tr.dataset.functionname = normalize(fnStr);
            tr.dataset.message = normalize(d.message||"");
            tr.dataset.user = normalize(userStr);
            tr.dataset.guild = normalize(guildStr);
            tr.dataset.textchannel = normalize(txStr);
            tr.dataset.voicechannel = normalize(vxStr);

            f.appendChild(tr);
          }catch{}
        }
        tbody.appendChild(f);

        // 1ページ目（最新）＆通常モード時は PAGE_SIZE 超過で上から削除
        if(mode==='normal' && (onLatestPage && (searchBox.value.trim()===''))){
          while(tbody.rows.length > PAGE_SIZE) tbody.deleteRow(0);
        }
      }

      function computeStartBaseNewestFirst(totalCount, pageIndex, pageChunkLength){
        const t = Math.max(0, Number(totalCount||0));
        const p = Math.max(1, Number(pageIndex||1));
        const len = Math.max(0, Number(pageChunkLength||0));
        const prevPagesCount = (p-1) * PAGE_SIZE;
        return Math.max(0, t - prevPagesCount - len);
      }

      function clearBody(){ tbody.innerHTML=""; }

      async function fetchJSON(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }

      // ---- 通常表示：page=1（最新）をロード ----
      async function initialLoad(){
        const d=await fetchJSON("/page?index=1&size="+PAGE_SIZE);
        const t=d.lines||""; const l=t?splitLinesNoRegex(t):[];
        totalLines=d.totalLines||l.length;
        totalPages=Math.max(1,Math.ceil(totalLines/PAGE_SIZE));
        currentPage=1; onLatestPage=true;
        lastPos=d.size??0; fileSize=d.size??0; pending="";
        clearBody();

        const base = (d.startIndex!=null)
          ? Number(d.startIndex)||0
          : computeStartBaseNewestFirst(totalLines, currentPage, l.length);

        appendRowsFromLines(l, base);
        bytesStat.textContent="size: "+humanBytes(fileSize); setPageInfo();
        setRowsStatVal();
        window.scrollTo({top:document.body.scrollHeight});
      }

      // ---- 追記監視（検索モード中は停止）----
      async function poll(){
        if(mode==='search') return;
        try{
          const h=await fetch("/head",{cache:'no-store'}).then(r=>r.json());
          const s=h.size??0; bytesStat.textContent="size: "+humanBytes(s);
          if(s===fileSize) return;

          if(onLatestPage && currentPage===1){
            const d=await fetchJSON("/data?pos="+lastPos), chunk=d.chunk||""; fileSize=d.size??s;
            let text=pending+chunk;
            const parts=splitLinesNoRegex(text);
            let tail=""; if(!endsWithNewline(text)) tail=parts.pop()||"";
            if(tail){ try{ JSON.parse(tail); parts.push(tail); pending=""; } catch{ pending=tail; } } else { pending=""; }
            const newLines=parts.filter(x=>x.length>0);
            if(newLines.length>0){
              let lastNumber = 0;
              const lastTr = tbody.lastElementChild;
              if(lastTr && lastTr.firstChild && lastTr.firstChild.textContent){
                lastNumber = Number(lastTr.firstChild.textContent) || 0;
              }else{
                lastNumber = totalLines - (tbody.rows.length || 0);
              }
              appendRowsFromLines(newLines, lastNumber);
              window.scrollTo({top:document.body.scrollHeight});
              totalLines+=newLines.length;
              totalPages=Math.max(1,Math.ceil(totalLines/PAGE_SIZE));
              setPageInfo();
              setRowsStatVal();
            }
            lastPos=fileSize;
          }else{
            fileSize=s; lastPos=s;
          }
        }catch{}
      }

      // ---- 通常ページ移動（newest-first）----
      async function goPage(i){
        if(mode==='search'){ return goSearchPage(i); }
        i=Math.max(1,i);
        try{
          const d=await fetchJSON("/page?index="+i+"&size="+PAGE_SIZE), t=d.lines||"", l=t?splitLinesNoRegex(t):[];
          totalLines=d.totalLines||totalLines; totalPages=Math.max(1,Math.ceil(totalLines/PAGE_SIZE));
          currentPage=i; onLatestPage=(currentPage===1); setPageInfo();
          clearBody();

          const base = (d.startIndex!=null)
            ? Number(d.startIndex)||0
            : computeStartBaseNewestFirst(totalLines, currentPage, l.length);

          appendRowsFromLines(l, base);
          window.scrollTo({ top: document.body.scrollHeight });
          setRowsStatVal();
        }catch{}
      }

      // =============================
      //  検索（サーバー全体 /search-window）
      // =============================
      async function runSearch(page){
        const q = searchBox.value.trim();
        const field = searchFieldSel.value || "message";
        const exclude = excludeToggle.checked ? 1 : 0;

        if(q===""){
          mode='normal';
          setRangeUIVisible(false);
          return initialLoad();
        }
        mode='search';

        // 範囲UIの表示ON
        setRangeUIVisible(true);

        const windex = searchParams.windowIndex || 0;
        try{
          const d=await fetchJSON(`/search-window?field=${encodeURIComponent(field)}&q=${encodeURIComponent(q)}&exclude=${exclude}&windex=${windex}&index=${page||1}&size=${PAGE_SIZE}`);
          const t=d.lines||""; const l=t?splitLinesNoRegex(t):[];

          // サーバーからの window 情報で状態を更新
          const w = d.window || {};
          searchParams = {
            field, q, exclude: !!exclude,
            page: d.pageIndex||1, totalPages: d.totalPages||1, total: d.total||l.length,
            windowIndex: (w.index!=null ? Number(w.index): (windex||0)),
            windowCount: (w.windowCount!=null ? Number(w.windowCount): 1),
            windowStartLine: (w.startLine!=null ? Number(w.startLine): 0),
            windowEndLine: (w.endLine!=null ? Number(w.endLine): 0)
          };

          setPageInfo();
          updateRangeUIState();

          clearBody();
          const nums = Array.isArray(d.numbers) ? d.numbers : null;
          appendRowsFromLines(l, 0, nums);
          setRowsStatVal();
          window.scrollTo({top:document.body.scrollHeight});
        }catch{}
      }
      async function goSearchPage(i){
        i=Math.max(1,Math.min(searchParams.totalPages||1,i));
        searchParams.page=i; await runSearch(i);
      }

      // UI イベント
      document.getElementById("prev").onclick=()=>{ if(mode==='search') goSearchPage((searchParams.page||1)-1); else goPage(currentPage-1); };
      document.getElementById("next").onclick=()=>{ if(mode==='search') goSearchPage((searchParams.page||1)+1); else goPage(currentPage+1); };
      searchBox.addEventListener("input", ()=> runSearch(1));
      searchFieldSel.addEventListener("change", ()=> runSearch(1));
      excludeToggle.addEventListener("change", ()=> runSearch(1));

      // 範囲UIボタン
      wprevBtn.addEventListener("click", ()=>{
        if(searchParams.windowIndex>0){
          searchParams.windowIndex -= 1;
          runSearch(1);
        }
      });
      wnextBtn.addEventListener("click", ()=>{
        if(searchParams.windowIndex < (searchParams.windowCount-1)){
          searchParams.windowIndex += 1;
          runSearch(1);
        }
      });

      // クリック→検索に反映（#, date, message は除外）
      // 0:#, 1:date, 2:type, 3:functionName, 4:message, 5:user, 6:guild, 7:textChannel, 8:voiceChannel
      function fieldByColIndex(idx){
        switch(idx){
          case 2: return "type";
          case 3: return "functionName";
          case 5: return "user";
          case 6: return "guild";
          case 7: return "textChannel";
          case 8: return "voiceChannel";
          default: return null;
        }
      }
      document.querySelector("#table tbody").addEventListener("click",(ev)=>{
        const tdEl = ev.target.closest("td");
        if(!tdEl) return;
        const idx = tdEl.cellIndex;
        const field = fieldByColIndex(idx);
        if(!field) return;
        const value = (tdEl.textContent||"").trim();
        if(!value) return;
        searchFieldSel.value = field;
        searchBox.value = value;
        // ウィンドウは最新側（0）から検索を開始
        searchParams.windowIndex = 0;
        runSearch(1);
      });

      // 起動
      await initialLoad();
      setInterval(poll, POLL_MS);
    })();
  </script>
</body>
</html>
