# 音楽bot
このプログラムは音楽botとしてDiscord Botを実行するプログラムです。

私の環境以外では**未検証です。**よって、他の環境でこのスクリプトを実行しても動作する保証はありません。

# はじめに
現在このbotはベータです。さまざまな配慮がされておらず、エラーが多く出てしまったり、ログが見づらかったり、未完成・無駄なコードが多々存在していたり、サーバーとして利用するには少し手を伸ばしづらいものとなっています。

とりあえず使ってみたいという方には「[音楽bot！の招待リンク](https://discord.com/oauth2/authorize?client_id=1028285721955553362&permissions=3264000&integration_type=0&scope=bot)」を利用してください。クリックするとDiscordでサーバーに追加することができます。フィードバックをする場合は、現時点でX(旧Twitter)の[@kazunami36_sum1](https://x.com/@kazunami36_sum1)へご連絡ください。手段は適当なポストにリプをしたり、メンションを行ったりするのが確実です。DMに連絡することも可能ですが、確実ではありません。

さらに、このREADME.mdすら完璧に書けていないので、さまざまな質問に関してもX(旧Twitter)アカウントにご連絡ください。TERMS.md、PRIVACY.mdについて、これはChatGPTによって作成されたものです。Discord Botの設定に使用するためのものです。こちらについても指摘をする場合はX(旧Twitter)にご連絡ください。

# 現時点の課題
このbotには多くの問題があります。
- /addコマンドの速度  
/addコマンドではApple Music、Spotify関連のURLを入力した際に取得完了まで時間がかかります。非同期処理を出来れば良いのですが、まだ準備中です。
- Apple MusicとSpotifyの精度
Apple MusicとSpotifyのURLは直接サービスから取得しているわけではなく、YouTubeに検索をかけて、決まったロジックを通して同じ曲であるだろうと推測する仕組みとなっています。その都合上間違った動画が出力されることも多々あります。
- MusicBrainzとの連携
このbotの特異性でもありますが、MusicBrainzを使用しています。しかし、MusicBrainzとYouTubeやApple Musicなどに関連づけるための仕組みがまだ完成していません。しかしAlbumInfoクラスを現在作成中のため、ここは解決する可能性が高いです。

# 仕様
この音楽botの仕様について解説します。

## 機能
この音楽botには様々な機能があります。

### 曲の追加
この音楽botでは主にYouTube、ニコニコ動画の追加をサポートしています。

## 使い方
このスクリプトは作者の私のbotで動かすのが通常です。しかし、このスクリプトをダウンロードした場合は次の方法で利用が可能です。

注意として、固有のURLを利用したりするため、正常に動作しない可能性があります。Issuesで要望を入れることで改善はできますが、自ら改善する予定は現時点でありません。あくまで参考程度に以下のセットアップをご覧ください。

1. .envに次のキーを入れる。
```
DISCORD_TOKEN=
YOUTUBE_API_KEY=
X_TOKEN=
X_TOKEN_SECRET=
X_API_KEY=
X_API_KEY_SECRET=
```
2. インストールする
```
npm i
```
3. FFmpegをインストールする
4. 起動する
```
npx tsc
node main
```
※もしこの手順で動かなかった場合はIssuesまたはX(旧Twitter)の@kazunami36_sum1にご連絡ください。

### 音楽bot側の操作方法
音楽botにはさまざまなコマンドが用意されています。それぞれ紹介します。

#### /add
曲をキューに追加します。`/add text:[テキスト]`という構文です。

#### /backseek
一発で再生位置を変更できる`/seek`のエイリアスです。標準は10秒です。`/backseek second:[数字]`で自由な時間戻せます。

#### /callch
音楽botをコマンド操作したりするためのチャンネルを指定できます。

#### /changetell
曲が自動で切り替わったりする時に、/playをしたチャンネルで通知をするかどうかを決められます。

#### /delete
キューに入った曲を削除することができます。

#### /help
ヘルプを表示しますが、ほとんど内容はありません。botのバージョンや、このリポジトリへのリンクが表示されます。

#### /mblink
MusicBrainzに関する情報をみたり、設定したりすることができます。しかし、設定は特定のユーザー(仕様では私のユーザーID)しか設定ができません。

#### /nextseek
一発で再生位置を変更できる`/seek`のエイリアスです。標準は10秒です。`/nextseek second:[数字]`で自由な時間進められます。

#### /pitch
音程を変更できます。

#### /play
キューに曲が入っている場合に再生を開始します。

#### /repeat
キューの進め方を決定します。
- オフ: キューの再生が終わるとキューから削除されて次の曲に行きます。一度消された曲は再度`/add`されるまで追加されません。
- リピート: キューの再生が終わると自動でキューの末尾に曲が移動します。
- １曲リピート: キューの再生が終わってもキューの変更がされません。`/skip`コマンドで曲を変更することができます。

#### /seek
再生位置を変更します。

#### /skip
曲をスキップします。`/status`から曲の番号を選ぶと、その曲にスキップされます。その時、キューの順番は乱れません。

#### /speed
再生速度を変更できます。

#### /status
キューの状態、再生位置、音量、音程、速度、音楽bot設定などを見ることができます。

#### /stop
再生を停止します。また、バグに見舞われている際にある程度リセットをすることができます。

#### /test
テストコマンドです。大抵何も起こらないです。

#### /volume
音量を調整します。

## ファイル毎の説明
この章ではファイル毎に役割を説明します。

### main.ts
実行する時に使うファイルです。グローバル変数を定義したり、botを立ち上げたり、さまざまな初期化をしたりする場所です。

### embed.ts
さまざまなDiscord埋め込みメッセージを作るテンプレートが入ったファイルです。関数がエクスポートされているため、アクセスして実行する専用のものです。

### envJSON.ts
これは大まかに２つの機能を備えています。

#### Discordサーバー・ユーザーデータ
`env.json`を作成し、そこにサーバーごとのデータを記録します。それらの処理を関数を通して読み込んだり、書き込んだりすることができます。

#### 配信サービス情報キャッシュ
`videoInfoCache.json`を作成し、そこにYouTubeやniconicoから得た情報をキャッシュし、アクセス時間を短縮します。このスクリプトは95%がChatGPT生成です。

### idToCustomMetadata.json
このプログラムではMusicBrainzというサービスを使っています。そのために、VideoIDなどの動画固有IDとMusicBrainzのMBIDという固有IDを関連づけるJSONを用意しています。これは僕が追記していったり、pull requestで良質な変更がされていた場合に追記していったりすることとなります。

### interface.ts
元はinterfaceを貯蓄するためのものでした。しかし、方針が変わってきているため、削除される恐れがあります。

### logger.ts
ChatGPTを使って作成しました。log生成用です。

### MusicBrainz.ts
95%以上がChatGPTによる生成です。`envData.ts`に似た機能が入っており、キャッシュデータ`musicBrainzCache.json`を作成します。

### niconico.ts
ChatGPTを使って作成しました。niconicoとのやり取りを行うAPIツールです。

### numberToTimeString.ts
numberから日本語形式の文字列に変換する便利スクリプトです。

### parseYtDlpProgressLine.ts
ChatGPTを使って作成しました。`yt-dlp`のjson出力を自動で分析し、わかりやすい形式に出力します。

### player.ts
Discord botのVC参加、音声読み込み、再生、切断全てを管理するプログラムです。

次の範囲をAIが担いました。
- 音程・速度変更に使われる`buildTempoPitchFilter`関数
- `toTimestamp`関数
- ffmpeg => バッファ => Discord Botの流れにあるバッファの部分

FFmpegを使用して再生をします。

再生位置、音程、速度、再生ソースの変更をした時、自動でFFmpegを修了してから即座に引数変更後のFFmpegを立ち上げて、まるで普通のプレイヤーを操作しているかのような感覚を実現するコードです。

### progressBar.ts
半分くらいChatGPTで作成しました。パーセントと表示する文字数を指定したら自動でインジケーターを作成する便利スクリプトです。

### serversData.ts
音楽botが動作する上で必要な一時的なデータです。保存する必要がない共有する変数をここに配置します。

### sourcePathManager.ts
IDとサービスタイプを入力すると、自動で音声の検索、ダウンロードから再生可能な形式の変換処理などまでを自動で行います。IDを入力するだけで音声ファイルのパスが帰ってきます。

### twitter.ts
ChatGPTを使って作成しました。X(旧Twitter)の情報を取得するAPIツールです。

### variableExistCheck.ts
Discord botのinteractionを実行する上で確認したい存在を集約した便利スクリプトです。

### webAPI.ts
main.tsを立ち上げた時に自動で立ち上がるWeb APIです。特定のドメインで配信する予定です。これを使うことによって、`main.ts`で接続しているDiscord Bot Clientと連携してサーバーの再生状態を変更したり、GUIで操作をしたり、曲を管理したりすることができるようになる予定です。

### guiフォルダ
GitHub PagesでホストするためのHTMLなどのファイルが入っています。

### interaction
Discord Botコマンドのスクリプトが入っています。**使い方**のところで詳しく解説しています。

# 将来追加したい機能
現在この音楽botにはさまざまな機能を期待しています。例をあげます。

## 実装途中
現在実装している最中ではあるが、全く機能しないか、バグが多すぎるものをあげます。

この章は入力途中で放置されています。

### Web API & GUI

### オリジナルファイル

## まだ構想
まだ手をつけていない機能をあげます。

### 再生時間記録
最近のストリーミングサービスは再生回数で判断しますが、僕のbotは再生時間で判断したいと考えています。たとえばスロー再生したり、途中で曲を変えたり、再生位置を変えたりした時でも、正確に再生した時間を記録してくれる機能です。

一応さまざまな見方ができるように２つの記録方式を採用します。

1. サーバー内で曲を流した時間  
音楽botがVCに参加して、そのVCでどれだけその曲を流したかを、曲毎に記録します。これのメリットはユーザーが入退出したかどうかや、その曲を聞きたいかどうかや、音楽botをミュートしているかどうかにかかわらず、かなり正確に再生した時間を記録することができます。しかし、VCに何十人も参加していて、全ての人がしっかり聴いていても、それら全てが１人分の再生時間として換算されます。

2. ユーザーがその曲を聴いた時間  
音楽botと一緒に参加しているユーザーの参加したタイミングや現在の曲の再生開始時間など全ての関係するものを計算して、ユーザーそれぞれに曲の再生時間を加算します。欠点はユーザーが音楽botをミュートしていても再生時間に加算される点です。

### プレイリスト
ユーザーそれぞれがプレイリストを持つことができます。ユーザーが聞きたいプレイリストを指定すると、キューが上書きされます。

### GUI関連
